<!DOCTYPE html>
<html lang="ru-ru"><head>
    <title>Гри-Гри для JWT</title>
    <link rel="icon"  type="image/x-icon" href="https://it-irokez.ru/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="Разбор узких мест безопасности JWT токенов на основе задач с root-me" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Гри-Гри для JWT" />
    <meta property="og:image" content="https://it-irokez.ru/assets/images/logo.jpg" />
    <meta property="og:url" content="https://it-irokez.ru/articles/grigri/" />
    <meta property="og:description" content="Разбор узких мест безопасности JWT токенов на основе задач с root-me" />
    <style>
@import "https://fonts.googleapis.com/css2?family=Inconsolata&display=swap";:root{--cursor-visibility:hidden}html,body{width:100%;height:100%;overflow:auto;font-family:inconsolata,monospace;font-size:4vmin;line-height:4.1vmin;font-weight:400}body{margin:0;display:flex;flex-direction:row;justify-content:center;align-items:center}#content{min-width:82vmin;min-height:82vmin}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{border-radius:10px;box-shadow:inset 0 0 1px white}::-webkit-scrollbar-thumb{border-radius:10px;box-shadow:0 0 0 1px white}.cursor,#activity-title:after,#activity-content:after,#cd:after,#whoami:after,#cat:after,#tree:after{visibility:var(--cursor-visibility);content:"|";overflow:hidden;color:#fff;animation:blink 500ms linear infinite alternate}@keyframes blink{0%{opacity:0}100%{opacity:1}}@media only screen and (min-width:768px){body{font-size:2.5vmin;line-height:2.6vmin}#content{min-width:60vmin}}:root{--cursor-visibility:hidden}body{align-items:unset;overflow-y:scroll}#content{max-width:80vmin}pre{overflow-x:scroll;white-space:pre}@keyframes blink{0%{opacity:0}100%{opacity:1}}















    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    



body{background:#1b1d1e}body #terminal{color:#BBBBBB}body #user{color:#23E298}body #dir{color:#D08010}body .Typewriter__cursor{color:#BBBBBB}a{color:#BBBBBB}

        

        
        
</style>



    <meta name="yandex-verification" content="355904de153d5134" />
    
    
    <script>window.yaContextCb = window.yaContextCb || []</script>
    <script src="https://yandex.ru/ads/system/context.js" async></script>

    <script type="text/javascript">
            (function (m, e, t, r, i, k, a) {
                m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
                m[i].l = 1 * new Date();
                for (var j = 0; j < document.scripts.length; j++) { if (document.scripts[j].src === r) { return; } }
                k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
            })
            (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(90533415, "init", {
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true
        });
    </script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/90533415" style="position:absolute; left:-9999px;" alt="" /></div>
    </noscript>
    


</head><body><div id="content">
<div id="mobile-block">
  
<div id="yandex_rtb_R-A-1957258-10"></div>
<script>window.yaContextCb.push(()=>{
  Ya.Context.AdvManager.render({
    renderTo: 'yandex_rtb_R-A-1957258-10',
    blockId: 'R-A-1957258-10'
  })
})</script>
</div>
<div id="block">

<div id="yandex_rtb_R-A-1957258-2"></div>
<script>window.yaContextCb.push(()=>{
  Ya.Context.AdvManager.render({
    renderTo: 'yandex_rtb_R-A-1957258-2',
    blockId: 'R-A-1957258-2'
  })
})</script>
</div>
<meta property="og:title" content="Гри-Гри для JWT"/>


    
    
    



    


    <span id='terminal'><h1 id='title'>Гри-Гри для JWT</h1><span id='date'>Опубликовано: 19-05-2020</span></span>

    <span id=''><p><a href="https://dc7495.org/gris-gris-for-jwt/">Оригинальная публикация</a></p>
<p><em><strong>Гри-гри</strong> — талисман вуду
или амулет для защиты
владельца от зла или на счастье.</em></p>
<p><strong>JWT</strong> (JSON Web Token) – это токен, а будет этот токен хорошим или плохим, зависит исключительно от вашей реализации. Структура JWT определена в <a href="https://tools.ietf.org/html/rfc7519">соответствующем RFC</a> , но если кратко, то JWT состоит из трех частей: заголовка (header), полезной нагрузки (payload) и подписи или данных шифрования. Заголовок и нагрузка представляют собой JSON-объекты “определенной” структуры, а третья часть – это зачастую подпись первой и второй частей. Если верить Википедии, то чаще всего вам придется сталкиваться с тем, что по науке называется JWS/JWE Compact Serialization, т.е. “компактная” версия токена. От развернутой она отличается тем, что заголовок и нагрузка кодируются в base64url, записываются через точку, после чего получившуюся строку подписывают, тоже кодируют в base64url и дописывают в конец снова через разделитель “точка”. Т.е. на выходе получается что-то вроде:</p>
<p><code>eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NSIsIm5hbWUiOiJKb2huIEdvbGQiLCJhZG1pbiI6dHJ1ZX0K.LIHjWCBORSWMEibq-tnT8ue_deUqZx1K0XxCOXZRrBI</code></p>
<p>Теперь чуть подробнее про каждую из частей, начнем, что называется, с головы. В заголовке указывается необходимая информация для описания самого токена.</p>
<p>Обязательный ключ здесь только один:</p>
<ul>
<li>alg: алгоритм, используемый для подписи/шифрования (в случае не подписанного JWT используется значение «none»).</li>
</ul>
<p>Необязательные ключи:</p>
<ul>
<li>typ: тип токена (type). Используется в случае, когда токены смешиваются с другими объектами, имеющими JOSE-заголовки. Должно иметь значение “JWT”.</li>
<li>cty: тип содержимого (content type). Если в токене помимо зарегистрированных служебных ключей есть пользовательские, то данный ключ не должен присутствовать. В противном случае он должен иметь значение “JWT”.</li>
</ul>
<p>В разделе полезной нагрузки указывается пользовательская информация (например, имя пользователя и уровень его доступа), а также могут быть использованы некоторые служебные ключи. Все они являются необязательными:</p>
<ul>
<li>iss: чувствительная к регистру строка или URI, которая является уникальным идентификатором стороны, генерирующей токен (issuer).</li>
<li>sub: чувствительная к регистру строка или URI, которая является уникальным идентификатором стороны, о которой содержится информация в данном токене (subject). Значения с этим ключом должны быть уникальны в контексте стороны, генерирующей JWT.</li>
<li>aud: массив чувствительных к регистру строк или URI, являющийся списком получателей данного токена. Когда принимающая сторона получает JWT с данным ключом, она должна проверить наличие себя в получателях — иначе проигнорировать токен (audience).</li>
<li>exp: время в формате Unix Time, определяющее момент, когда токен станет невалидным (expiration).</li>
<li>nbf: в противовес ключу exp, время в формате Unix Time, определяющее момент, когда токен станет валидным (not before).</li>
<li>jti: строка, определяющая уникальный идентификатор данного токена (JWT ID).</li>
<li>iat: время в формате Unix Time, определяющее момент, когда токен был создан. iat и nbf могут не совпадать, например, если токен был создан раньше, чем время, когда он должен стать валидным.</li>
</ul>
<h1 id="кейсы">Кейсы</h1>
<p>Теперь, когда ты, дорогой читатель, получил базовое представление о том, что такое JWT-токен, я могу перестать копипастить Википедию и заняться разбором проколов, связанных с безопасностью JWT на примере заданий с root-me:</p>
<ul>
<li><a href="https://www.root-me.org/en/Challenges/Web-Server/JSON-Web-Token-JWT-Introduction">JSON Web Token (JWT) – Introduction</a></li>
<li><a href="https://www.root-me.org/en/Challenges/Web-Server/JSON-Web-Token-JWT-Weak-secret">JSON Web Token (JWT) – Weak secret</a></li>
<li><a href="https://www.root-me.org/en/Challenges/Web-Server/JSON-Web-Token-JWT-Public-key">JSON Web Token (JWT) – Public key</a></li>
</ul>
<p>И сразу ссылки на полезные источники, которые позволят вам избежать дальнейшего чтения моей статьи:</p>
<ul>
<li><a href="https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/">Attacking JWT authentication</a></li>
<li><a href="https://medium.com/101-writeups/hacking-json-web-token-jwt-233fe6c862e6">Hacking JSON Web Token (JWT)</a></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>В задании говорится о том, что необходимо авторизоваться под админом, чтобы получить флаг. Точкой входа предстает такая форма:</p>
<p><img src="/assets/images/gri_1.png" alt="форма"></p>
<p>Так как аккаунта у нас нет, а задание явно направлено на злоупотребление каким-нибудь токеном, попробуем авторизоваться как гость:</p>
<p><img src="/assets/images/gri_2.png" alt="guest"></p>
<p>И получаем заветный токен в куке:</p>
<p><img src="/assets/images/gri_3.png" alt="токен"></p>
<p>Хватаем содержимое куки jwt и идем с ним на <a href="https://jwt.io">jwt.io</a> , где и лицезреем следующую картину:</p>
<p><img src="/assets/images/gri_4.png" alt=""></p>
<p>Чутье бывалого проникновенца говорит нам, что необходимо поменять username с guest на admin и переподписать все это дело. Однако HMAC с использованием SHA-256 требует от нас знания некоего секрета, который создатель задания сообщить нам забыл… Да кому вообще нужна эта подпись, сгенерируем себе токен и без нее:</p>
<p><img src="/assets/images/gri_5.jpeg" alt=""></p>
<p>Заменяем значение куки jwt на полученный токен и надеемся, что программист ресурса не такой крутой профессионал, как мы:</p>
<p><img src="/assets/images/gri_6.png" alt=""></p>
<p>Вы великолепны! Вы не зря зовете себя ковбоем клавиатуры!</p>
<h2 id="weak-secret">Weak secret</h2>
<p>По одному только названию становится понятно, в чем в этот раз будет проблема. Но давайте не будем сильно забегать вперед и для начала поговорим о том, что за “HS256” использовался для подписи сообщения в предыдущем примере. HS256 – это HMAC with SHA-256. Что это значит для нас, простых смертных людей, не обремененных знаниями криптографической магии? Интернет говорит, что HMAC (Hash-based Message Authentication Code) – это код аутентификации сообщения на основе хэширования. Данный вид аутентификации подразумевает наличие у клиента и сервера некоего секретного ключа, который известен только им двоим. Отлично, опытный проникновенец внутри вас наверняка прочитал эту фразу как “это что-то симметричное и его можно сбрутить”. Теперь мы морально готовы приступать к заданию с root-me.</p>
<p>Поехали. Точка входа в задание одаривает нас JSON-ом следующего содержания:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{     
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Let&#39;s play a small game, I bet you cannot access to my super secret admin section. Make a GET request to /token and use the token you&#39;ll get to try to access /admin with a POST request.&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Я, конечно, не уверен, но, кажется, нам необходимо сделать GET-запрос на /token. Оттуда на нас нисходит новый JSON:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Here is your token&#34;</span>: <span style="color:#e6db74">&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJyb2xlIjoiZ3Vlc3QifQ.4kBPNf7Y6BrtP-Y3A-vQXPY9jAh_d0E6L4IUjL65CvmEjgdTZyr2ag-TM-glH6EYKGgO3dBYbhblaPQsbeClcw&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="/assets/images/gri_7.png" alt=""></p>
<p>Поле role, вероятнее всего, придется сменить с guest на admin, но сразу возникает вопрос валидности подписи. Если же в этом задании вы решите попробовать поменять алгоритм подписи на различные вариации None, то это не сработает. Название челленджа как бы намекает…</p>
<p>Намекает на то, что можно воспользоваться утилитой типа <a href="https://github.com/Sjord/jwtcrack">jwtcrack</a>  или <a href="https://github.com/magnumripper/JohnTheRipper">John the Ripper</a>  (я так и не понял, как заставить его работать с jwt), которые позволят узнать секрет методом словарного перебора и переподписать себе токен.</p>
<p>Запускаем jwtcrack:</p>
<p><img src="/assets/images/gri_8.png" alt=""></p>
<p>Фантастика, мы заполучили секрет и теперь можем переписать себе токен:</p>
<p><img src="/assets/images/gri_9.png" alt=""></p>
<p>Его мы засовываем в заголовок Authorization (почему-то без Bearer) и получаем ключ этой таски. Можно рассказывать теперь историю этого взлома в баре “Джентльмен неудачник”; историю про сожжение Хром вы, конечно, не затмите, но использовать стойкие ключи научите.</p>
<h2 id="public-key">Public key</h2>
<p>В этот раз без теоретического введения, с места в карьер, так сказать. В челлендже нам дают три endpoint-а api:</p>
<ol>
<li>/key (GET)</li>
<li>/auth (POST)</li>
<li>/admin (POST)</li>
</ol>
<p>И говорят, чтобы мы всех хакнули.</p>
<p>Пойдем по порядку и постучим на key:</p>
<p><img src="/assets/images/gri_10.png" alt=""></p>
<p>Как и ожидалось, мы получили ключ… Публичный. Сохраняем его себе куда-нибудь и идем дальше. На /auth нас просят послать свой username в теле запроса. Выполнив требования, получаем:</p>
<p><img src="/assets/images/gri_11.png" alt=""></p>
<p>Вы уже поняли, да? Идем на jwt.io  и смотрим на то, что мы получили:</p>
<p><img src="/assets/images/gri_12.png" alt=""></p>
<p>Видим RS256, и это печалит. Сразу становится понятно, зачем нам дали публичный ключ. RS – это RSA SHA, а RSA (Rivest-Shamir-Adleman) использует асимметричные ключи. Вы, конечно, можете попробовать способы из предыдущих двух заданий, но они тут не сработают. Зато сработает ход, который в обычных условиях показался бы не самым логичным. Давайте попробуем изменить алгоритм подписи с RS256 на HS256, а в качестве секретного ключа использовать полученный нами ранее публичный ключ.</p>
<p>Возникает логичный вопрос, а какого черта это вообще должно сработать? Мы надеемся на то, что код расшифровки токена на сервере выглядит как-то так:</p>
<p><img src="/assets/images/gri_13.png" alt=""></p>
<p>И все это прекрасно работает, если у нас действительно используется асимметричный алгоритм подписи (в нашем случае RSA SHA-256), но если вместо чего-то асимметричного туда попадает что-то симметричное (HMAC SHA-256), то публичный ключ будет обработан функцией как симметричный ключ и токен будет валиден.</p>
<p>Дальше придется произвести пляски с бубном, которые бы не пришлось проводить будь версия pyjwt не такой свежей. Связано это с тем, что свежие версии pyjwt не дают использовать публичный ключ в качестве секрета для HS256. Но начнем мы все равно с python:</p>
<p><img src="/assets/images/gri_14.png" alt=""></p>
<p>Отсюда нам понадобятся заголовок и нагрузка:</p>
<p><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0</code></p>
<p>А вот подписывать эти части нам придется самостоятельно.</p>
<p>Перегоним наш ключ, полученный ранее, в последовательность HEX-ов:</p>
<p><code>2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b43415145417576773168347477504a6e5a42772b54327743440a59624832556b4d427852672f686b534d6c365a77693259566d37397771723372506433676a7430695a576432724e42337175644b5749536d42516132517152480a74503666546a6569354d413471734c53586c32724765576a47767471704851446d63583447417841454b7947306e6632445065324170454330323152472f564f0a64595343414149702b536d6443746d35504966314153694f4141585537644c37324959736f63534d6759705249634a755a5341435571314a367775553958796c0a7042314e7657774644334659437a72655435416b5469636276676546316b39792f4f4b5431667632626e5347706a354b4d45462f51575552377877337262516b0a796e6365436a714645744c78584873584a506d5536676a4132494377547131475671435a447a6a6a665162426f4b7a6d59534f774c7a4f6e364a6237454f50670a58514944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a</code></p>
<p>А теперь самостоятельно, как взрослые мальчики, подпишем себе токен:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo -n <span style="color:#e6db74">&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0&#34;</span> | openssl dgst -sha256 -mac HMAC -macopt hexkey: 2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b43415145417576773168347477504a6e5a42772b54327743440a59624832556b4d427852672f686b534d6c365a77693259566d37397771723372506433676a7430695a576432724e42337175644b5749536d42516132517152480a74503666546a6569354d413471734c53586c32724765576a47767471704851446d63583447417841454b7947306e6632445065324170454330323152472f564f0a64595343414149702b536d6443746d35504966314153694f4141585537644c37324959736f63534d6759705249634a755a5341435571314a367775553958796c0a7042314e7657774644334659437a72655435416b5469636276676546316b39792f4f4b5431667632626e5347706a354b4d45462f51575552377877337262516b0a796e6365436a714645744c78584873584a506d5536676a4132494377547131475671435a447a6a6a665162426f4b7a6d59534f774c7a4f6e364a6237454f50670a58514944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a
</span></span></code></pre></div><p>Наша подпись:</p>
<p><code>f4a3602e56b0b5d07229d66130ef0aedd1d338cbdc543641d0bb8bedaf8f65ba</code></p>
<p>Но не спешите подставлять ее в наш токен. Вы ведь помните, что подпись должна быть base64url? Кодируем:</p>
<p>Но не спешите подставлять ее в наш токен. Вы ведь помните, что подпись должна быть base64url? Кодируем:</p>
<p>Получаем:</p>
<p>9KNgLlawtdByKdZhMO8K7dHTOMvcVDZB0LuL7a-PZbo</p>
<p>Собираем токен в кучу:</p>
<p><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.9KNgLlawtdByKdZhMO8K7dHTOMvcVDZB0LuL7a-PZbo</code></p>
<p>Засовываем в заголовок Authorization: Bearer и хвастаемся еще одним успешным взломом.</p>
</span>



    </div>
    <style>
    h1 {
         
        color: #23E298;
        line-height: 6vmin;
        font-size: 6vmin;
    }


    #block {
        max-height: 350px;
        max-width: 1000px;
    }



    a,
    strong,
    ::marker,
    #date {
        color: #D08010;

    }

    table,
    td {
        border-collapse: collapse;
        border: 2px solid #D08010;
        max-width: 100%;
    }

    td {
        padding: 25px;
    }

    li a {
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        font-size: 1em;
        line-height: 1.56;
    }

    li {
        padding-left: 2%;


    }

    a {
        text-decoration: none;
        font-size: 1em;
    }

    img {
        max-width: 100%;
        max-height: 80vh;
    }

    .navFull {
        background-color: #353535;
        line-height: 150%;
        font-family: "Courier New";
         
        display: inline;
        position: fixed;
        bottom: 0px;
        left: 0px;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        width: 100%;
        align-items: baseline;
        padding-top: 5px;
        padding: 10px;
        padding-bottom: 0px;
    }

     
    .navCredits {
        float: right;
        padding-right: 18px;
        padding-bottom: 10px;
         
    }

    #navigationBlock {}

    #content::after {
        content: "\a\a";
        white-space: pre;
    }

    
    #content {
        max-width: 80vw;
        font-size: 1.8vmax;
        line-height: 1.56;
        overflow-wrap: break-word;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        color: #BBBBBB;
    }
    @media only screen and (max-width : 1000px){
        #block {
            display: none;
        }
    }
    @media only screen and (min-width : 1000px){
        #mobile-block {
            display: none;
        }
    }
    @media only screen and (min-width : 1400px) {
        #content {
            font-size: 2.0vmin;
        }

    }
    li p {
        padding-left: 5%;
    }

    #coffee {
        background-color: #D08010;
        color: #fff;
        display: block;
        padding: 10px;
        border-width: 2px;
        border-radius: 10px;
    }

    @media only screen and (max-width:500px) {
        #content {
            padding-left: 2%;
        }

        body {
            font-size: 1.2em;
        }

        .navFull {
            line-height: 100%;
        }
    }
</style>

    
    <span class="navFull">
        
    
    

    
        

<div id="navigationBlock">
    <a href="/">Home</a>
    <span>&#8192;|&#8192;</span>
    <a href="./..">/articles/</a>
</div>

    

        
        <div class="navCredits">
            <a id="coffee" href="https://www.tinkoff.ru/cf/qTUdfLwVFO">Купить автору кофе</a>
        </div>
</span>


    

    

</body>

</html>